

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>341</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js'></script>
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.js"></script><

	<style>
	.thumb {
	    max-height:80px;
	    max-width:80px;
	}
	</style>
</head>
<body>

<script type='text/html' id='overview_template'>
	<div class='width:100%;padding:10px;display:none;'>
  		<img class='current-image' src='<%=Url%>' style='width:100%'/>
  		<p>LastModified: <%=LastModified%></p><p>(<%=AgeFormatted%>)</p>
  	</div>
</script>



<div data-role="page" id="photos" data-cache='false'>
	<header data-role="header">
		<h1>341 Garage</h1>
	</header>
	<article data-role="content">
		<div class='image-parent'>
		</div>
	</article>
	<footer data-role="footer" data-position="fixed">
		<nav data-role="navbar">
			<ul>
				<li><a href="home" data-icon="home">Home</a></li>
				<li><a href="Photos" data-icon="grid">Photos</a></li>
				<li><a href="Info" data-icon="info">Info</a></li>
			</ul>
		</nav>
	</footer>
</div>

</body>


<script>

var publicReadKey = '[An aws key from a IAM account with readonly public access to the bucket]';
var publicReadSecretKey = '[An aws secret key from a IAM account with readonly public access to the bucket]';

// IAM: POLICY TEMPLATE
//
// 1. Create an IAM group with this policy
// 2. Create a user, add to only this group
// 3. User that users keys
// {
//     "Version": "2012-10-17",
//     "Statement": [
//         {
//             "Effect": "Allow",
//             "Action": [
//                 "s3:Get*",
//                 "s3:List*"
//             ],
//             "Resource": "arn:aws:s3:::BUCKET_NAME/*"
//         }
//     ]
// }



 AWS.config.update({accessKeyId: publicReadKey, secretAccessKey: publicReadSecretKey});
 
  var bucket = new AWS.S3({params: {Bucket: '341-webcam'}});
  var root = 'http://341-webcam.s3.amazonaws.com/';
  var defaultPrefix = 'images/';
  
  function getAgeInSeconds(item) {
      
      var createTime = new Date(item.LastModified);
      
      try {
      var delta = 0xfffffffffffffff - Number("0x" + item.Key.match(/\/([0-9a-f]+)_/)[1]);
      
      createTime = new Date(delta);
      }
      catch (err) {
          
      }
         
      item.CreateTime = createTime;
      
      return Math.round((new Date().getTime() - createTime.getTime()) / 1000);
      
  }

  function formatAge(age) {
  	if (age > 60) {
  		age = Math.round(age / 60) + " minutes ago";
  	}
  	else {
  		age = Math.round(age) + " seconds ago";
  	}
  	return age;
  }

  function getObjects(prefix, max, callback) {

	bucket.listObjects({Prefix:prefix || defaultPrefix ,MaxKeys:max}, function (err, data) {
	    if (err) {
	      // document.getElementById('status').innerHTML =
	      //   'Could not load objects from S3 ' + err.toString();
	      callback(err);
	    } else {

	    	var items = _.map(data.Contents, function(item){
	    		  item.Url = root + item.Key;
		          item.Age = getAgeInSeconds(item);
		          item.AgeFormatted = formatAge(item.Age);
		          return item;
	    	});
	    	callback(null, items);
	    }
	  });
  }

  var sites = [
  	{ name: 'garage',
  	 folder:'images',
  	 refresh: 10
  	}
  ];
  //var detailTemplate = _.template($("#detail_template").html());
  var overviewTemplate =  _.template($("#overview_template").html());
  //var pageTemplate =  _.template($("#page_template").html());
  function populateHome() {

  		var parent =$('.image-parent');
  		_.each(sites, function(s){

  			getObjects(s.folder, 1, function(err, items){
  				if (err) {

  				}
  				else {
  					var item = _.first(items);

  					if (item) {
  						var html = $(overviewTemplate({
  							Name: s.name,
  							Url: item.Url,
  							Target: s.folder,
  							LastModified:  item.CreateTime,
  							Age: item.Age,
  							AgeFormatted: item.AgeFormatted
  						}));

  						$('img',html).load(function() {
  							html.show();
  							parent.empty();
  							parent.append(html);
  						});
  						

  						_.delay(populateHome, 5000);
  					}
  				}
  			});
  		});

  }

  populateHome();


</script>

</html>
